<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Instagram Planner</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #f5f0eb;
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
  padding: 24px; gap: 28px; flex-wrap: wrap;
}

/* ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ */
#config {
  background:#fff; border-radius:16px; padding:28px;
  max-width:360px; width:100%;
  box-shadow: 0 4px 24px rgba(0,0,0,.08);
}
#config h2 { font-size:17px; font-weight:700; margin-bottom:4px; }
#config p  { font-size:12px; color:#888; margin-bottom:20px; line-height:1.5; }
label { display:block; font-size:11px; font-weight:700; color:#555; margin-bottom:3px; text-transform:uppercase; letter-spacing:.5px; }
input {
  width:100%; border:1.5px solid #e4e4e4; border-radius:8px;
  padding:9px 11px; font-size:13px; color:#1a1a1a;
  margin-bottom:13px; outline:none; transition:border-color .2s;
}
input:focus { border-color:#8b6f5e; }
#loadBtn {
  width:100%; background:#1a1a1a; color:#fff;
  border:none; border-radius:8px; padding:11px;
  font-size:14px; font-weight:600; cursor:pointer; transition:opacity .2s;
}
#loadBtn:hover { opacity:.8; }
.hint { font-size:11px; color:#bbb; margin-top:14px; text-align:center; line-height:1.6; }
.hint a { color:#8b6f5e; }

/* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
#status { display:none; text-align:center; padding:20px; font-size:13px; color:#888; }
.spinner { width:22px; height:22px; border:2px solid #e0e0e0; border-top-color:#8b6f5e; border-radius:50%; animation:spin .8s linear infinite; margin:0 auto 8px; }
@keyframes spin { to { transform:rotate(360deg); } }

/* ‚îÄ‚îÄ WIDGET ‚îÄ‚îÄ */
#widget { display:none; align-items:flex-start; gap:28px; flex-wrap:wrap; justify-content:center; }

/* ‚îÄ‚îÄ PHONE ‚îÄ‚îÄ */
.phone-shell {
  width:260px; background:#fff; border-radius:42px;
  box-shadow: 0 0 0 9px #111, 0 28px 56px rgba(0,0,0,.28);
  position:relative; overflow:hidden; flex-shrink:0;
}
.dynamic-island {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  width:72px; height:20px; background:#111; border-radius:20px; z-index:20;
}
.screen { height:600px; overflow-y:scroll; overflow-x:hidden; scrollbar-width:none; }
.screen::-webkit-scrollbar { display:none; }

.status-bar {
  padding:16px 18px 4px;
  display:flex; justify-content:space-between; align-items:center;
  position:sticky; top:0; background:#fff; z-index:10;
}
.time { font-weight:700; font-size:12px; color:#111; }
.status-icons { display:flex; gap:4px; align-items:center; }
.status-icons svg { width:14px; height:14px; }

.ig-topbar {
  padding:4px 14px 8px;
  display:flex; align-items:center; justify-content:space-between;
  position:sticky; top:32px; background:#fff; z-index:9;
}
.ig-handle { font-size:16px; font-weight:800; letter-spacing:-.3px; }
.ig-topbar-icons { display:flex; gap:14px; }
.ig-topbar-icons svg { width:22px; height:22px; fill:none; stroke:#111; stroke-width:1.8; }

.profile-section { padding:10px 14px 0; }
.profile-row { display:flex; align-items:center; gap:16px; margin-bottom:12px; }
.avatar-big { width:68px; height:68px; border-radius:50%; flex-shrink:0; background:linear-gradient(135deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888); padding:2.5px; }
.avatar-inner { width:100%; height:100%; border-radius:50%; background:#fff; padding:2px; display:flex; align-items:center; justify-content:center; }
.avatar-letter { font-size:24px; font-weight:700; color:#111; }
.stats { display:flex; flex:1; justify-content:space-around; }
.stat { text-align:center; }
.stat-num { font-size:14px; font-weight:800; display:block; color:#111; }
.stat-lbl { font-size:10px; color:#555; }
.bio { font-size:11.5px; line-height:1.5; color:#111; margin-bottom:10px; }
.bio strong { display:block; font-weight:700; font-size:12px; }
.action-row { display:flex; gap:6px; margin-bottom:12px; }
.btn-follow { flex:1; background:#0095f6; color:#fff; border:none; border-radius:8px; padding:6px 0; font-size:12px; font-weight:700; cursor:pointer; }
.btn-msg    { flex:1; background:#efefef; color:#111; border:none; border-radius:8px; padding:6px 0; font-size:12px; font-weight:700; cursor:pointer; }

.highlights { display:flex; gap:10px; padding:0 0 12px; overflow-x:auto; scrollbar-width:none; }
.highlights::-webkit-scrollbar { display:none; }
.hl-item { text-align:center; flex-shrink:0; }
.hl-ring { width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg,#f09433,#e6683c,#dc2743); padding:2px; margin:0 auto 3px; }
.hl-inner { width:100%; height:100%; border-radius:50%; background:#e8e0d8; display:flex; align-items:center; justify-content:center; border:2px solid #fff; }
.hl-emoji { font-size:20px; }
.hl-label { font-size:9px; color:#111; }

.tabs { display:flex; border-top:1px solid #dbdbdb; border-bottom:1px solid #dbdbdb; margin-bottom:2px; }
.tab { flex:1; display:flex; align-items:center; justify-content:center; padding:10px 0; cursor:pointer; }
.tab svg { width:20px; height:20px; fill:none; stroke:#aaa; stroke-width:1.8; }
.tab.active svg { stroke:#111; }
.tab.active { border-bottom:2px solid #111; margin-bottom:-1px; }

/* GRID 4:5 */
.ig-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:2px; }
.ig-cell { aspect-ratio:4/5; background:#e8e0d8; position:relative; overflow:hidden; cursor:pointer; }
.ig-cell img { width:100%; height:100%; object-fit:cover; display:block; }
.ig-cell .overlay {
  position:absolute; inset:0;
  background:linear-gradient(to top,rgba(0,0,0,.55) 0%,transparent 55%);
  opacity:0; transition:opacity .25s;
  display:flex; flex-direction:column; justify-content:flex-end;
  padding:6px 5px;
}
.ig-cell:hover .overlay { opacity:1; }
.overlay-date { font-size:8px; font-weight:700; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,.6); }
.ig-cell.empty { background:#ece7e2; }

/* ‚îÄ‚îÄ UPCOMING ‚îÄ‚îÄ */
.upcoming { background:#fff; border-radius:16px; padding:20px; width:220px; box-shadow:0 4px 16px rgba(0,0,0,.07); max-height:600px; overflow-y:auto; flex-shrink:0; }
.upcoming::-webkit-scrollbar { display:none; }
.upcoming h3 { font-size:12px; font-weight:800; color:#1a1a1a; margin-bottom:14px; text-transform:uppercase; letter-spacing:.6px; }
.up-item { display:flex; gap:10px; align-items:flex-start; padding:9px 0; border-bottom:1px solid #f4f0ec; }
.up-item:last-child { border-bottom:none; }
.up-thumb { width:42px; height:52px; border-radius:6px; background:#e8e0d8; flex-shrink:0; overflow:hidden; }
.up-thumb img { width:100%; height:100%; object-fit:cover; }
.up-date  { font-size:10px; color:#c89b7b; font-weight:700; margin-bottom:2px; }
.up-title { font-size:11px; color:#1a1a1a; font-weight:600; line-height:1.3; }

#resetBtn { display:none; text-align:center; font-size:11px; color:#bbb; cursor:pointer; text-decoration:underline; margin-top:8px; }
</style>
</head>
<body>

<div id="config">
  <h2>üì± Instagram Grid Preview</h2>
  <p>Conect√° tu database de Notion para visualizar tus posts en un mock-up de Instagram.</p>

  <label>Notion Integration Token</label>
  <input type="password" id="token" placeholder="secret_xxxxxxxxxxxx">

  <label>Database ID</label>
  <input type="text" id="dbId" placeholder="10ca47eb27c980c98ed9f7016b79b6ea">

  <label>Nombre de la propiedad de fecha</label>
  <input type="text" id="dateProp" value="Publication Date">

  <label>Instagram Handle</label>
  <input type="text" id="handle" value="ladonaira">

  <button id="loadBtn">Conectar ‚Üí</button>
  <p class="hint">El token se usa solo para llamar a la API de Notion directamente.<br>Nunca se almacena ni se env√≠a a ning√∫n otro servidor.<br><br><a href="https://www.notion.so/my-integrations" target="_blank">Crear integraci√≥n ‚Üí</a></p>
</div>

<div id="status"><div class="spinner"></div><span id="statusMsg">Cargando‚Ä¶</span></div>

<div id="widget">
  <div>
    <div class="phone-shell">
      <div class="dynamic-island"></div>
      <div class="screen">

        <div class="status-bar">
          <span class="time" id="clockTime">9:41</span>
          <div class="status-icons">
            <svg viewBox="0 0 17 12"><rect x="0" y="6" width="3" height="6" fill="#111" rx=".5"/><rect x="4.5" y="4" width="3" height="8" fill="#111" rx=".5"/><rect x="9" y="2" width="3" height="10" fill="#111" rx=".5"/><rect x="13.5" y="0" width="3" height="12" fill="#111" rx=".5"/></svg>
            <svg viewBox="0 0 16 12" fill="none"><path d="M8 10.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" fill="#111"/><path d="M5.5 8C6.4 7.1 7.1 6.7 8 6.7s1.6.4 2.5 1.3" stroke="#111" stroke-width="1.3" stroke-linecap="round"/><path d="M3.5 6C4.9 4.6 6.4 3.8 8 3.8s3.1.8 4.5 2.2" stroke="#111" stroke-width="1.3" stroke-linecap="round"/><path d="M1.5 4C3.3 2.2 5.5 1 8 1s4.7 1.2 6.5 3" stroke="#111" stroke-width="1.3" stroke-linecap="round"/></svg>
            <svg viewBox="0 0 24 12"><rect x=".5" y=".5" width="20" height="11" rx="2.5" stroke="#111"/><path d="M21 4v4a2 2 0 0 0 0-4z" fill="#111"/><rect x="2" y="2" width="15" height="8" rx="1.5" fill="#111"/></svg>
          </div>
        </div>

        <div class="ig-topbar">
          <span class="ig-handle" id="igHandle">ladonaira</span>
          <div class="ig-topbar-icons">
            <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6" stroke-linecap="round"/><line x1="3" y1="12" x2="21" y2="12" stroke-linecap="round"/><line x1="3" y1="18" x2="21" y2="18" stroke-linecap="round"/></svg>
          </div>
        </div>

        <div class="profile-section">
          <div class="profile-row">
            <div class="avatar-big"><div class="avatar-inner"><span class="avatar-letter" id="avatarLetter">L</span></div></div>
            <div class="stats">
              <div class="stat"><span class="stat-num" id="postCount">‚Äî</span><span class="stat-lbl">posts</span></div>
              <div class="stat"><span class="stat-num">2.4k</span><span class="stat-lbl">followers</span></div>
              <div class="stat"><span class="stat-num">312</span><span class="stat-lbl">following</span></div>
            </div>
          </div>
          <div class="bio"><strong id="bioHandle">La Donaira</strong>Organic farm &amp; eco retreat ¬∑ Andalusia üåø<br>Slow living, regenerative land, honest food.</div>
          <div class="action-row">
            <button class="btn-follow">Follow</button>
            <button class="btn-msg">Message</button>
          </div>
          <div class="highlights">
            <div class="hl-item"><div class="hl-ring"><div class="hl-inner"><span class="hl-emoji">üåæ</span></div></div><div class="hl-label">Farm</div></div>
            <div class="hl-item"><div class="hl-ring"><div class="hl-inner"><span class="hl-emoji">üç∑</span></div></div><div class="hl-label">Wine</div></div>
            <div class="hl-item"><div class="hl-ring"><div class="hl-inner"><span class="hl-emoji">üõñ</span></div></div><div class="hl-label">Stays</div></div>
            <div class="hl-item"><div class="hl-ring"><div class="hl-inner"><span class="hl-emoji">üåø</span></div></div><div class="hl-label">Recipes</div></div>
            <div class="hl-item"><div class="hl-ring"><div class="hl-inner"><span class="hl-emoji">‚ú®</span></div></div><div class="hl-label">Events</div></div>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx=".5"/><rect x="14" y="3" width="7" height="7" rx=".5"/><rect x="3" y="14" width="7" height="7" rx=".5"/><rect x="14" y="14" width="7" height="7" rx=".5"/></svg></div>
          <div class="tab"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="3" x2="12" y2="7"/><line x1="12" y1="17" x2="12" y2="21"/><line x1="3" y1="12" x2="7" y2="12"/><line x1="17" y1="12" x2="21" y2="12"/></svg></div>
          <div class="tab"><svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7" stroke-linecap="round" stroke-width="2.5"/></svg></div>
        </div>

        <div class="ig-grid" id="igGrid"></div>
      </div>
    </div>
    <div id="resetBtn" onclick="reset()">‚Üê Cambiar database</div>
  </div>

  <div class="upcoming" id="upcomingPanel"><h3>üìÖ Pr√≥ximos</h3></div>
</div>

<script>
const NV = '2022-06-28';

function tick() {
  const n = new Date();
  document.getElementById('clockTime').textContent =
    n.getHours().toString().padStart(2,'0') + ':' + n.getMinutes().toString().padStart(2,'0');
}
tick(); setInterval(tick, 10000);

function fmtShort(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('es-ES', { day:'numeric', month:'short' });
}
function fmtFull(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('es-ES', { day:'numeric', month:'short', year:'2-digit' });
}
function getDate(page, prop) {
  const f = page.properties[prop];
  if (!f) return '';
  if (f.type === 'date') return f.date?.start || '';
  if (f.type === 'created_time') return f.created_time;
  return '';
}
function getImg(page) {
  if (page.cover)
    return page.cover.type === 'external' ? page.cover.external.url : page.cover.file?.url;
  for (const k in page.properties) {
    const p = page.properties[k];
    if (p.type === 'files' && p.files?.length) {
      const f = p.files[0];
      return f.type === 'external' ? f.external.url : f.file?.url;
    }
  }
  return null;
}
function getTitle(page) {
  for (const k in page.properties)
    if (page.properties[k].type === 'title')
      return page.properties[k].title?.map(t => t.plain_text).join('') || '';
  return '';
}

async function notionQuery(token, dbId) {
  // Calls the Netlify serverside function (avoids CORS)
  const res = await fetch('/.netlify/functions/notion', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token, dbId })
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.message || `Error ${res.status}: ${data.code || ''}`);
  return data;
}

document.getElementById('loadBtn').onclick = async () => {
  const token  = document.getElementById('token').value.trim();
  const dbId   = document.getElementById('dbId').value.trim().replace(/-/g,'');
  const dateP  = document.getElementById('dateProp').value.trim();
  const handle = document.getElementById('handle').value.trim() || 'ladonaira';

  if (!token || !dbId) { alert('Ingres√° el token y el database ID.'); return; }
  showStatus('Conectando con Notion‚Ä¶');

  try {
    const data  = await notionQuery(token, dbId);
    const pages = (data.results || [])
      .filter(p => !!getDate(p, dateP))
      .sort((a, b) => new Date(getDate(b, dateP)) - new Date(getDate(a, dateP)));

    document.getElementById('igHandle').textContent    = handle;
    document.getElementById('bioHandle').textContent   = handle;
    document.getElementById('avatarLetter').textContent = handle[0].toUpperCase();
    document.getElementById('postCount').textContent   = pages.length;

    renderGrid(pages, dateP);
    renderUpcoming(pages, dateP);

    document.getElementById('config').style.display  = 'none';
    document.getElementById('status').style.display  = 'none';
    document.getElementById('widget').style.display  = 'flex';
    document.getElementById('resetBtn').style.display = 'block';

  } catch(e) {
    showStatus(`‚ùå ${e.message}`, true);
  }
};

function renderGrid(pages, dateP) {
  const grid = document.getElementById('igGrid');
  grid.innerHTML = '';
  const total = Math.max(pages.length, 9);
  const hues  = [25,200,140,310,50,170,260,35,100];

  for (let i = 0; i < total; i++) {
    const cell = document.createElement('div');
    cell.className = 'ig-cell';
    if (i < pages.length) {
      const img = getImg(pages[i]);
      if (img) {
        const im = document.createElement('img');
        im.src = img; im.alt = ''; im.loading = 'lazy';
        cell.appendChild(im);
      } else {
        cell.style.background = `hsl(${hues[i % hues.length]},22%,82%)`;
      }
      const ov = document.createElement('div');
      ov.className = 'overlay';
      ov.innerHTML = `<div class="overlay-date">${fmtShort(getDate(pages[i], dateP))}</div>`;
      cell.appendChild(ov);
    } else {
      cell.classList.add('empty');
    }
    grid.appendChild(cell);
  }
}

function renderUpcoming(pages, dateP) {
  const panel = document.getElementById('upcomingPanel');
  panel.innerHTML = '<h3>üìÖ Pr√≥ximos</h3>';
  const today = new Date(); today.setHours(0,0,0,0);
  const list = pages
    .filter(p => new Date(getDate(p, dateP)) >= today)
    .sort((a,b) => new Date(getDate(a,dateP)) - new Date(getDate(b,dateP)))
    .slice(0, 12);

  if (!list.length) {
    panel.innerHTML += '<p style="font-size:12px;color:#bbb;margin-top:8px">No hay posts futuros con fecha.</p>';
    return;
  }
  list.forEach(p => {
    const img  = getImg(p);
    const date = getDate(p, dateP);
    const item = document.createElement('div');
    item.className = 'up-item';
    item.innerHTML = `
      <div class="up-thumb">${img ? `<img src="${img}" alt="" loading="lazy">` : ''}</div>
      <div>
        <div class="up-date">${fmtFull(date)}</div>
        <div class="up-title">${getTitle(p)}</div>
      </div>`;
    panel.appendChild(item);
  });
}

function showStatus(msg, isErr) {
  document.getElementById('config').style.display = 'none';
  const s = document.getElementById('status');
  s.style.display = 'block';
  s.innerHTML = isErr
    ? `<p style="color:#c0392b;font-size:13px">${msg}</p><button onclick="reset()" style="margin-top:12px;padding:8px 16px;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-size:12px">‚Üê Reintentar</button>`
    : `<div class="spinner"></div><span>${msg}</span>`;
}

function reset() {
  document.getElementById('widget').style.display  = 'none';
  document.getElementById('status').style.display  = 'none';
  document.getElementById('config').style.display  = 'block';
  document.getElementById('resetBtn').style.display = 'none';
}
</script>
</body>
</html>
