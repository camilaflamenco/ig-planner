<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IG Planner Widget</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #f5f0eb;
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
  padding: 24px; gap: 28px; flex-wrap: wrap;
}

/* ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ */
#config {
  background:#fff; border-radius:16px; padding:28px;
  max-width:400px; width:100%;
  box-shadow: 0 4px 24px rgba(0,0,0,.08);
}
#config h2 { font-size:17px; font-weight:700; margin-bottom:4px; }
#config > p { font-size:12px; color:#888; margin-bottom:20px; line-height:1.5; }
.section-title {
  font-size:11px; font-weight:800; color:#1a1a1a;
  text-transform:uppercase; letter-spacing:.6px;
  margin:20px 0 12px; padding-bottom:6px; border-bottom:1px solid #f0f0f0;
}
label { display:block; font-size:11px; font-weight:700; color:#555; margin-bottom:3px; text-transform:uppercase; letter-spacing:.5px; }
input, textarea {
  width:100%; border:1.5px solid #e4e4e4; border-radius:8px;
  padding:9px 11px; font-size:13px; color:#1a1a1a;
  margin-bottom:13px; outline:none; transition:border-color .2s; font-family:inherit;
}
textarea { resize:vertical; min-height:56px; }
input:focus, textarea:focus { border-color:#8b6f5e; }
.stats-row { display:flex; gap:8px; }
.stats-row > div { flex:1; }
.hl-row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
.hl-row input { margin-bottom:0; }
.hl-row input:first-child { width:48px; flex-shrink:0; text-align:center; font-size:18px; padding:6px; }
.hl-remove { background:none; border:none; color:#ccc; font-size:20px; cursor:pointer; padding:0 4px; flex-shrink:0; line-height:1; }
.hl-remove:hover { color:#e74c3c; }
.add-hl-btn {
  background:none; border:1.5px dashed #ddd; border-radius:8px;
  color:#aaa; font-size:12px; padding:7px; width:100%;
  cursor:pointer; margin-bottom:13px; transition:all .2s;
}
.add-hl-btn:hover { border-color:#8b6f5e; color:#8b6f5e; }
#loadBtn {
  width:100%; background:#1a1a1a; color:#fff; border:none;
  border-radius:8px; padding:12px; font-size:14px; font-weight:600;
  cursor:pointer; transition:opacity .2s; margin-top:4px;
}
#loadBtn:hover { opacity:.8; }
.hint { font-size:11px; color:#bbb; margin-top:14px; text-align:center; line-height:1.6; }
.hint a { color:#8b6f5e; }
.avatar-upload-row { display:flex; gap:8px; align-items:flex-start; margin-bottom:13px; }
.avatar-upload-row input { margin-bottom:0; flex:1; }
.avatar-upload-btn {
  flex-shrink:0; background:#f5f0eb; border:1.5px solid #e4e4e4;
  border-radius:8px; padding:9px 10px; font-size:12px; cursor:pointer;
  white-space:nowrap; transition:all .2s; color:#555;
}
.avatar-upload-btn:hover { border-color:#8b6f5e; color:#8b6f5e; }

/* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
#status { display:none; text-align:center; padding:20px; font-size:13px; color:#888; }
.spinner { width:22px; height:22px; border:2px solid #e0e0e0; border-top-color:#8b6f5e; border-radius:50%; animation:spin .8s linear infinite; margin:0 auto 8px; }
@keyframes spin { to { transform:rotate(360deg); } }

/* ‚îÄ‚îÄ WIDGET ‚îÄ‚îÄ */
#widget { display:none; align-items:flex-start; justify-content:center; }

/* ‚îÄ‚îÄ TOP BUTTONS ‚îÄ‚îÄ */
.top-btns { display:flex; gap:8px; margin-bottom:14px; width:260px; }
.top-btn {
  flex:1; padding:8px 0; border-radius:10px; font-size:11px; font-weight:700;
  cursor:pointer; border:1.5px solid #e4e4e4; background:#fff; color:#555;
  transition:all .2s; text-align:center;
}
.top-btn:hover { border-color:#1a1a1a; color:#1a1a1a; }
.top-btn.active { background:#1a1a1a; color:#fff; border-color:#1a1a1a; }

/* pin mode button hint */
#pinHint {
  width:260px; text-align:center; font-size:10px; color:#8b6f5e;
  margin-bottom:10px; display:none;
  background:#fff8f4; border-radius:8px; padding:6px;
}

/* ‚îÄ‚îÄ PHONE ‚îÄ‚îÄ */
.phone-shell {
  width:260px; background:#fff; border-radius:42px;
  box-shadow: 0 0 0 9px #111, 0 28px 56px rgba(0,0,0,.28);
  position:relative; overflow:hidden;
}
.dynamic-island { position:absolute; top:10px; left:50%; transform:translateX(-50%); width:72px; height:20px; background:#111; border-radius:20px; z-index:20; }
.screen { height:600px; overflow-y:scroll; overflow-x:hidden; scrollbar-width:none; }
.screen::-webkit-scrollbar { display:none; }

.status-bar { padding:16px 18px 4px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; background:#fff; z-index:10; }
.time { font-weight:700; font-size:12px; color:#111; }
.status-icons { display:flex; gap:4px; align-items:center; }
.status-icons svg { width:14px; height:14px; }

.ig-topbar { padding:4px 14px 8px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:32px; background:#fff; z-index:9; }
.ig-handle-text { font-size:16px; font-weight:800; letter-spacing:-.3px; }
.ig-topbar-icons { display:flex; gap:14px; }
.ig-topbar-icons svg { width:22px; height:22px; fill:none; stroke:#111; stroke-width:1.8; cursor:pointer; }

.profile-section { padding:8px 14px 0; }
.profile-row { display:flex; align-items:center; gap:14px; margin-bottom:8px; }

/* smaller avatar */
.avatar-big { width:52px; height:52px; border-radius:50%; flex-shrink:0; background:linear-gradient(135deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888); padding:2px; }
.avatar-inner { width:100%; height:100%; border-radius:50%; background:#fff; padding:2px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
.avatar-inner img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
.avatar-letter { font-size:18px; font-weight:700; color:#111; }

/* smaller lighter stats */
.stats-ig { display:flex; flex:1; justify-content:space-around; }
.stat { text-align:center; }
.stat-num { font-size:12px; font-weight:400; display:block; color:#111; }
.stat-lbl { font-size:9px; color:#888; }

.bio-ig { font-size:8.5px; line-height:1.3; color:#111; margin-bottom:4px; }
.bio-ig strong { display:block; font-weight:700; font-size:9.5px; margin-bottom:1px; }
.bio-ig a { color:#0095f6; text-decoration:none; }
.bio-link { display:block; font-size:8.5px; color:#0095f6; font-weight:600; margin-bottom:6px; text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

.action-row { display:flex; gap:6px; margin-bottom:10px; }
.btn-follow { flex:1; background:#0095f6; color:#fff; border:none; border-radius:8px; padding:6px 0; font-size:12px; font-weight:700; cursor:pointer; }
.btn-msg    { flex:1; background:#efefef; color:#111; border:none; border-radius:8px; padding:6px 0; font-size:12px; font-weight:700; cursor:pointer; }

.highlights-ig { display:flex; gap:10px; padding:0 0 10px; overflow-x:auto; scrollbar-width:none; }
.highlights-ig::-webkit-scrollbar { display:none; }
.hl-item { text-align:center; flex-shrink:0; }
.hl-ring { width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg,#f09433,#e6683c,#dc2743); padding:2px; margin:0 auto 3px; }
.hl-inner-ig { width:100%; height:100%; border-radius:50%; background:#e8e0d8; display:flex; align-items:center; justify-content:center; border:2px solid #fff; overflow:hidden; }
.hl-emoji { font-size:18px; }
.hl-label-ig { font-size:9px; color:#111; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:48px; }

/* 4-tab bar */
.tabs { display:flex; border-top:1px solid #dbdbdb; border-bottom:1px solid #dbdbdb; margin-bottom:2px; }
.tab { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 0; cursor:pointer; gap:2px; }
.tab svg { width:18px; height:18px; fill:none; stroke:#aaa; stroke-width:1.8; }
.tab span { font-size:7px; color:#aaa; letter-spacing:.3px; text-transform:uppercase; font-weight:600; }
.tab.active svg { stroke:#111; }
.tab.active span { color:#111; }
.tab.active { border-bottom:2px solid #111; margin-bottom:-1px; }

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.ig-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:2px; }
.ig-cell { aspect-ratio:4/5; background:#e8e0d8; position:relative; overflow:hidden; cursor:pointer; }
.ig-cell img { width:100%; height:100%; object-fit:cover; display:block; }
.ig-cell .overlay {
  position:absolute; inset:0;
  background:linear-gradient(to top,rgba(0,0,0,.55) 0%,transparent 50%);
  opacity:0; transition:opacity .2s;
  display:flex; flex-direction:column; justify-content:flex-end; padding:5px;
}
.ig-cell:hover .overlay { opacity:1; }
.overlay-date { font-size:8px; font-weight:700; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,.6); }

/* carousel */
.cell-arrow {
  position:absolute; top:50%; transform:translateY(-50%);
  background:rgba(0,0,0,.45); border:none; border-radius:50%;
  width:20px; height:20px; display:flex; align-items:center; justify-content:center;
  cursor:pointer; opacity:0; transition:opacity .2s; z-index:5; color:#fff; font-size:11px; line-height:1;
}
.ig-cell:hover .cell-arrow { opacity:1; }
.cell-arrow.prev { left:4px; }
.cell-arrow.next { right:4px; }
.cell-arrow:hover { background:rgba(0,0,0,.7); }
.cell-dots { position:absolute; top:5px; left:0; right:0; display:flex; justify-content:center; gap:3px; z-index:5; opacity:0; transition:opacity .2s; }
.ig-cell:hover .cell-dots { opacity:1; }
.cell-dot { width:4px; height:4px; border-radius:50%; background:rgba(255,255,255,.5); }
.cell-dot.active { background:#fff; }
.multi-badge { position:absolute; top:5px; right:5px; z-index:4; background:rgba(0,0,0,.5); border-radius:4px; padding:2px 4px; }
.multi-badge svg { width:9px; height:9px; fill:#fff; display:block; }
.ig-cell.empty { background:#ece7e2; }

/* pin button ‚Äî shows on hover */
.pin-btn {
  position:absolute; bottom:5px; right:5px; z-index:6;
  background:rgba(0,0,0,.5); border:none; border-radius:50%;
  width:18px; height:18px; display:flex; align-items:center; justify-content:center;
  cursor:pointer; opacity:0; transition:opacity .2s; padding:0;
}
.ig-cell:hover .pin-btn { opacity:1; }
.pin-btn svg { width:10px; height:10px; fill:#fff; }
.pin-btn.pinned { opacity:1 !important; background:rgba(255,200,0,.85); }
.pin-btn.pinned svg { fill:#111; }

/* pin indicator badge */
.pin-badge {
  position:absolute; top:4px; left:4px; z-index:6;
  background:rgba(255,200,0,.9); border-radius:50%;
  width:14px; height:14px; display:flex; align-items:center; justify-content:center;
  font-size:8px;
}

/* pin mode ‚Äî cells pulsing border */
.pin-mode .ig-cell:not(.empty):not(.pinned-cell) { outline:2px dashed rgba(139,111,94,.4); }
.pin-mode .ig-cell.pinned-cell { outline:2px solid #f0c040; }

/* ‚îÄ‚îÄ PROFILE OVERLAY ‚îÄ‚îÄ */
#profileOverlay {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,.45); z-index:100;
  align-items:center; justify-content:center; padding:20px;
}
.profile-editor {
  background:#fff; border-radius:16px; padding:28px;
  width:100%; max-width:360px;
  box-shadow:0 8px 40px rgba(0,0,0,.2);
  max-height:90vh; overflow-y:auto;
}
.profile-editor::-webkit-scrollbar { display:none; }
.editor-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.editor-header h3 { font-size:16px; font-weight:700; }
.close-btn { background:none; border:none; font-size:24px; cursor:pointer; color:#aaa; line-height:1; }
.save-btn { width:100%; background:#1a1a1a; color:#fff; border:none; border-radius:8px; padding:11px; font-size:14px; font-weight:600; cursor:pointer; }
</style>
</head>
<body>

<!-- CONFIG -->
<div id="config">
  <h2>üì± IG Planner Widget</h2>
  <p>Configur√° el perfil y conect√° tu database de Notion.</p>

  <div class="section-title">üîå Notion</div>
  <label>Integration Token</label>
  <input type="password" id="token" placeholder="ntn_xxxxxxxxxxxx">
  <label>Database ID</label>
  <input type="text" id="dbId" placeholder="10ca47eb27c980c98ed9f7016b79b6ea">
  <label>Propiedad de fecha</label>
  <input type="text" id="dateProp" value="Publication Date">

  <div class="section-title">üë§ Perfil</div>
  <label>Handle (sin @)</label>
  <input type="text" id="cfgHandle" placeholder="millieflame">
  <label>Nombre para mostrar</label>
  <input type="text" id="cfgName" placeholder="Millie Flame">
  <label>Bio</label>
  <textarea id="cfgBio" placeholder="Community Manager ‚ú®&#10;@agencia ¬∑ creando con intenci√≥n"></textarea>
  <label>Link web</label>
  <input type="text" id="cfgWebsite" placeholder="https://millieflame.com">
  <label>Foto de perfil</label>
  <div class="avatar-upload-row">
    <input type="text" id="cfgAvatar" placeholder="URL o sub√≠ desde galer√≠a ‚Üí">
    <button class="avatar-upload-btn" onclick="document.getElementById('avatarFileInput').click()">üìÅ Galer√≠a</button>
    <input type="file" id="avatarFileInput" accept="image/*" style="display:none">
  </div>

  <div class="section-title">üìä Estad√≠sticas</div>
  <div class="stats-row">
    <div><label>Posts publicados</label><input type="text" id="cfgPublished" placeholder="48"></div>
    <div><label>Seguidores</label><input type="text" id="cfgFollowers" placeholder="2.4k"></div>
    <div><label>Siguiendo</label><input type="text" id="cfgFollowing" placeholder="312"></div>
  </div>

  <div class="section-title">‚≠ï Highlights</div>
  <div id="hlList"></div>
  <button class="add-hl-btn" id="addHlBtn">+ Agregar highlight</button>

  <button id="loadBtn">Conectar y ver ‚Üí</button>
  <p class="hint">El token se usa solo para llamar a Notion directamente.<br><a href="https://www.notion.so/my-integrations" target="_blank">Crear integraci√≥n ‚Üí</a></p>
</div>

<!-- STATUS -->
<div id="status"><div class="spinner"></div></div>

<!-- WIDGET -->
<div id="widget">
  <div>
    <div class="top-btns">
      <button class="top-btn" onclick="openProfileEditor()">‚úèÔ∏è Editar perfil</button>
      <button class="top-btn" id="toggleBtn" onclick="toggleView()">üìÖ + Programados</button>
      <button class="top-btn" id="pinModeBtn" onclick="togglePinMode()">üìå Fijar</button>
    </div>
    <div id="pinHint">Clic en una imagen para fijarla arriba ¬∑ M√°x. 3 ¬∑ Clic en üìå para terminar</div>

    <div class="phone-shell">
      <div class="dynamic-island"></div>
      <div class="screen">

        <div class="status-bar">
          <span class="time" id="clockTime">9:41</span>
          <div class="status-icons">
            <svg viewBox="0 0 17 12"><rect x="0" y="6" width="3" height="6" fill="#111" rx=".5"/><rect x="4.5" y="4" width="3" height="8" fill="#111" rx=".5"/><rect x="9" y="2" width="3" height="10" fill="#111" rx=".5"/><rect x="13.5" y="0" width="3" height="12" fill="#111" rx=".5"/></svg>
            <svg viewBox="0 0 16 12" fill="none"><path d="M8 10.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" fill="#111"/><path d="M5.5 8C6.4 7.1 7.1 6.7 8 6.7s1.6.4 2.5 1.3" stroke="#111" stroke-width="1.3" stroke-linecap="round"/><path d="M3.5 6C4.9 4.6 6.4 3.8 8 3.8s3.1.8 4.5 2.2" stroke="#111" stroke-width="1.3" stroke-linecap="round"/><path d="M1.5 4C3.3 2.2 5.5 1 8 1s4.7 1.2 6.5 3" stroke="#111" stroke-width="1.3" stroke-linecap="round"/></svg>
            <svg viewBox="0 0 24 12"><rect x=".5" y=".5" width="20" height="11" rx="2.5" stroke="#111"/><path d="M21 4v4a2 2 0 0 0 0-4z" fill="#111"/><rect x="2" y="2" width="15" height="8" rx="1.5" fill="#111"/></svg>
          </div>
        </div>

        <div class="ig-topbar">
          <span class="ig-handle-text" id="igHandle">handle</span>
          <div class="ig-topbar-icons">
            <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <svg viewBox="0 0 24 24" onclick="openProfileEditor()" title="Editar perfil"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </div>
        </div>

        <div class="profile-section">
          <div class="profile-row">
            <div class="avatar-big">
              <div class="avatar-inner" id="avatarInner">
                <span class="avatar-letter" id="avatarLetter">?</span>
              </div>
            </div>
            <div class="stats-ig">
              <div class="stat"><span class="stat-num" id="postCount">‚Äî</span><span class="stat-lbl">posts</span></div>
              <div class="stat"><span class="stat-num" id="igFollowers">‚Äî</span><span class="stat-lbl">followers</span></div>
              <div class="stat"><span class="stat-num" id="igFollowing">‚Äî</span><span class="stat-lbl">following</span></div>
            </div>
          </div>
          <div class="bio-ig"><strong id="igName"></strong><span id="igBio"></span></div>
          <a class="bio-link" id="igWebsite" href="#" target="_blank" style="display:none"></a>
          <div class="action-row">
            <button class="btn-follow">Follow</button>
            <button class="btn-msg">Message</button>
          </div>
          <div class="highlights-ig" id="igHighlights"></div>
        </div>

        <div class="tabs">
          <div class="tab active">
            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx=".5"/><rect x="14" y="3" width="7" height="7" rx=".5"/><rect x="3" y="14" width="7" height="7" rx=".5"/><rect x="14" y="14" width="7" height="7" rx=".5"/></svg>
            <span>Posts</span>
          </div>
          <div class="tab">
            <svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="3"/><circle cx="12" cy="12" r="3"/><line x1="2" y1="9" x2="22" y2="9"/><line x1="9" y1="2" x2="9" y2="9"/><line x1="15" y1="2" x2="15" y2="9"/></svg>
            <span>Reels</span>
          </div>
          <div class="tab">
            <svg viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
            <span>Reposts</span>
          </div>
          <div class="tab">
            <svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7" stroke-linecap="round" stroke-width="2.5"/></svg>
            <span>Tagged</span>
          </div>
        </div>

        <div class="ig-grid" id="igGrid"></div>
      </div>
    </div>
  </div>
</div>

<!-- PROFILE EDITOR OVERLAY -->
<div id="profileOverlay">
  <div class="profile-editor">
    <div class="editor-header">
      <h3>‚úèÔ∏è Editar perfil</h3>
      <button class="close-btn" onclick="closeProfileEditor()">√ó</button>
    </div>
    <label>Handle (sin @)</label>
    <input type="text" id="editHandle">
    <label>Nombre para mostrar</label>
    <input type="text" id="editName">
    <label>Bio</label>
    <textarea id="editBio"></textarea>
    <label>Link web</label>
    <input type="text" id="editWebsite">
    <label>Foto de perfil</label>
    <div class="avatar-upload-row">
      <input type="text" id="editAvatar" placeholder="URL o sub√≠ desde galer√≠a ‚Üí">
      <button class="avatar-upload-btn" onclick="document.getElementById('editAvatarFile').click()">üìÅ Galer√≠a</button>
      <input type="file" id="editAvatarFile" accept="image/*" style="display:none">
    </div>
    <div class="stats-row">
      <div><label>Posts publicados</label><input type="text" id="editPublished"></div>
      <div><label>Seguidores</label><input type="text" id="editFollowers"></div>
      <div><label>Siguiendo</label><input type="text" id="editFollowing"></div>
    </div>
    <div class="section-title" style="margin-top:4px;">‚≠ï Highlights</div>
    <div id="editHlList"></div>
    <button class="add-hl-btn" id="editAddHlBtn">+ Agregar highlight</button>
    <button class="save-btn" onclick="saveProfileEditor()">Guardar cambios</button>
  </div>
</div>

<script>
const NV = '2022-06-28';
let allPages = [];
let currentDateProp = '';
let showingScheduled = false;
let pinMode = false;
let pinnedIds = []; // ordered list of pinned page IDs (max 3)

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
function tick() {
  const n = new Date();
  document.getElementById('clockTime').textContent =
    n.getHours().toString().padStart(2,'0') + ':' + n.getMinutes().toString().padStart(2,'0');
}
tick(); setInterval(tick, 10000);

// ‚îÄ‚îÄ FILE UPLOADS ‚îÄ‚îÄ
document.getElementById('avatarFileInput').addEventListener('change', e => {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => document.getElementById('cfgAvatar').value = ev.target.result;
  r.readAsDataURL(f);
});
document.getElementById('editAvatarFile').addEventListener('change', e => {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => document.getElementById('editAvatar').value = ev.target.result;
  r.readAsDataURL(f);
});

// ‚îÄ‚îÄ HIGHLIGHTS ‚îÄ‚îÄ
let hlData = [
  { emoji:'‚≠ê', label:'Highlights' },
  { emoji:'üì∏', label:'Feed' },
  { emoji:'üéØ', label:'Goals' },
];
function buildHlRows(containerId, data) {
  const list = document.getElementById(containerId);
  list.innerHTML = '';
  data.forEach((hl, i) => {
    const row = document.createElement('div');
    row.className = 'hl-row';
    row.innerHTML = `
      <input type="text" value="${hl.emoji}" maxlength="2" data-i="${i}" data-f="emoji">
      <input type="text" value="${hl.label}" placeholder="Nombre" data-i="${i}" data-f="label">
      <button class="hl-remove" data-i="${i}">√ó</button>`;
    list.appendChild(row);
  });
  list.querySelectorAll('input').forEach(inp =>
    inp.addEventListener('input', () => { data[+inp.dataset.i][inp.dataset.f] = inp.value; }));
  list.querySelectorAll('.hl-remove').forEach(btn =>
    btn.addEventListener('click', () => { data.splice(+btn.dataset.i,1); buildHlRows(containerId,data); }));
}
buildHlRows('hlList', hlData);
document.getElementById('addHlBtn').onclick = () => {
  hlData.push({ emoji:'‚ú®', label:'Nuevo' }); buildHlRows('hlList', hlData);
};

// ‚îÄ‚îÄ BIO PARSER ‚îÄ‚îÄ
function parseBio(text) {
  if (!text) return '';
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank">$1</a>')
    .replace(/@([\w.]+)/g,'<a href="https://instagram.com/$1" target="_blank">@$1</a>')
    .replace(/\n/g,'<br>');
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function fmtShort(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('es-ES',{day:'numeric',month:'short'});
}
function getDate(page, prop) {
  const f = page.properties[prop];
  if (!f) return '';
  if (f.type==='date') return f.date?.start||'';
  if (f.type==='created_time') return f.created_time;
  return '';
}
function getAllImgs(page) {
  const imgs = [];
  if (page.cover) {
    const u = page.cover.type==='external' ? page.cover.external.url : page.cover.file?.url;
    if (u) imgs.push(u);
  }
  for (const k in page.properties) {
    const p = page.properties[k];
    if (p.type==='files') p.files?.forEach(f => {
      const u = f.type==='external' ? f.external.url : f.file?.url;
      if (u && !imgs.includes(u)) imgs.push(u);
    });
  }
  if (page._imageBlocks?.length)
    page._imageBlocks.forEach(u => { if (!imgs.includes(u)) imgs.push(u); });
  return imgs;
}
function getTitle(page) {
  for (const k in page.properties)
    if (page.properties[k].type==='title')
      return page.properties[k].title?.map(t=>t.plain_text).join('')||'';
  return '';
}

// ‚îÄ‚îÄ NOTION API ‚îÄ‚îÄ
async function notionQuery(token, dbId) {
  const res = await fetch('/.netlify/functions/notion', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({token, dbId, fetchBlocks:true})
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.message||`Error ${res.status}`);
  return data;
}

// ‚îÄ‚îÄ CONNECT ‚îÄ‚îÄ
document.getElementById('loadBtn').onclick = async () => {
  const token     = document.getElementById('token').value.trim();
  const dbId      = document.getElementById('dbId').value.trim().replace(/-/g,'');
  const dateP     = document.getElementById('dateProp').value.trim();
  const handle    = document.getElementById('cfgHandle').value.trim()||'handle';
  const name      = document.getElementById('cfgName').value.trim()||handle;
  const bio       = document.getElementById('cfgBio').value.trim();
  const website   = document.getElementById('cfgWebsite').value.trim();
  const avatar    = document.getElementById('cfgAvatar').value.trim();
  const published = document.getElementById('cfgPublished').value.trim();
  const followers = document.getElementById('cfgFollowers').value.trim()||'‚Äî';
  const following = document.getElementById('cfgFollowing').value.trim()||'‚Äî';

  if (!token||!dbId) { alert('Ingres√° el token y el database ID.'); return; }
  showStatus(true);

  try {
    const data = await notionQuery(token, dbId);
    allPages = (data.results||[])
      .filter(p => !!getDate(p, dateP))
      .sort((a,b) => new Date(getDate(b,dateP)) - new Date(getDate(a,dateP)));
    currentDateProp = dateP;
    showingScheduled = false;
    pinnedIds = [];

    const today = new Date(); today.setHours(0,0,0,0);
    const publishedPages = allPages.filter(p => new Date(getDate(p,dateP)) <= today);

    applyProfile({handle,name,bio,website,avatar,followers,following,
      posts: published||publishedPages.length});
    renderHighlights(hlData);
    renderGrid();

    document.getElementById('toggleBtn').textContent = 'üìÖ + Programados';
    document.getElementById('toggleBtn').classList.remove('active');
    document.getElementById('config').style.display = 'none';
    document.getElementById('status').style.display = 'none';
    document.getElementById('widget').style.display = 'flex';
  } catch(e) {
    showStatus(false, e.message);
  }
};

// ‚îÄ‚îÄ TOGGLE: published only ‚Üî published + scheduled ‚îÄ‚îÄ
function toggleView() {
  showingScheduled = !showingScheduled;
  const btn = document.getElementById('toggleBtn');
  btn.textContent   = showingScheduled ? '‚úÖ Solo publicados' : 'üìÖ + Programados';
  btn.classList.toggle('active', showingScheduled);
  renderGrid();
}

// ‚îÄ‚îÄ PIN MODE ‚îÄ‚îÄ
function togglePinMode() {
  pinMode = !pinMode;
  const btn  = document.getElementById('pinModeBtn');
  const hint = document.getElementById('pinHint');
  btn.classList.toggle('active', pinMode);
  btn.textContent = pinMode ? 'üìå Listo' : 'üìå Fijar';
  hint.style.display = pinMode ? 'block' : 'none';
  document.getElementById('igGrid').classList.toggle('pin-mode', pinMode);
}

function togglePin(pageId) {
  if (pinnedIds.includes(pageId)) {
    pinnedIds = pinnedIds.filter(id => id !== pageId);
  } else {
    if (pinnedIds.length >= 3) {
      alert('M√°ximo 3 posts fijados. Desancla uno primero.');
      return;
    }
    pinnedIds.push(pageId);
  }
  renderGrid();
}

// ‚îÄ‚îÄ RENDER GRID ‚îÄ‚îÄ
function renderGrid() {
  const today = new Date(); today.setHours(0,0,0,0);

  // Base pool: always published. If toggle on, add scheduled too.
  let pool = allPages.filter(p => new Date(getDate(p, currentDateProp)) <= today);
  if (showingScheduled) {
    const scheduled = allPages.filter(p => new Date(getDate(p, currentDateProp)) > today);
    pool = [...pool, ...scheduled];
  }

  // Pinned first (in pin order), then rest
  const pinned  = pinnedIds.map(id => pool.find(p => p.id === id)).filter(Boolean);
  const unpinned = pool.filter(p => !pinnedIds.includes(p.id));
  const pages   = [...pinned, ...unpinned];

  const grid  = document.getElementById('igGrid');
  grid.innerHTML = '';
  const total = Math.max(pages.length, 9);
  const hues  = [25,200,140,310,50,170,260,35,100];

  for (let i = 0; i < total; i++) {
    const cell = document.createElement('div');
    cell.className = 'ig-cell';

    if (i < pages.length) {
      const p    = pages[i];
      const imgs = getAllImgs(p);
      const date = getDate(p, currentDateProp);
      const isPinned = pinnedIds.includes(p.id);
      const isScheduled = new Date(date) > today;
      if (isPinned) cell.classList.add('pinned-cell');

      // scheduled = slight opacity
      if (isScheduled) cell.style.opacity = '0.65';

      const im = document.createElement('img');
      im.alt=''; im.loading='lazy';
      if (imgs.length) { im.src = imgs[0]; }
      else { im.style.display='none'; cell.style.background=`hsl(${hues[i%hues.length]},22%,82%)`; }
      cell.appendChild(im);

      // carousel
      if (imgs.length > 1) {
        let idx = 0;
        const dotsWrap = document.createElement('div');
        dotsWrap.className = 'cell-dots';
        imgs.forEach((_,di) => {
          const dot = document.createElement('div');
          dot.className = 'cell-dot'+(di===0?' active':'');
          dotsWrap.appendChild(dot);
        });
        cell.appendChild(dotsWrap);

        const badge = document.createElement('div');
        badge.className = 'multi-badge';
        badge.innerHTML = `<svg viewBox="0 0 24 24"><rect x="0" y="6" width="17" height="14" rx="2" fill="none" stroke="#fff" stroke-width="2"/><path d="M2 4h15a2 2 0 0 1 2 2v13" stroke="#fff" stroke-width="2" fill="none"/></svg>`;
        cell.appendChild(badge);

        const prev = document.createElement('button');
        prev.className='cell-arrow prev'; prev.textContent='‚Äπ';
        const next = document.createElement('button');
        next.className='cell-arrow next'; next.textContent='‚Ä∫';

        function goTo(ni) {
          idx=(ni+imgs.length)%imgs.length; im.src=imgs[idx];
          dotsWrap.querySelectorAll('.cell-dot').forEach((d,di)=>d.classList.toggle('active',di===idx));
        }
        prev.onclick = e => { e.stopPropagation(); goTo(idx-1); };
        next.onclick = e => { e.stopPropagation(); goTo(idx+1); };
        cell.appendChild(prev);
        cell.appendChild(next);
      }

      // pin badge (shows position number if pinned)
      if (isPinned) {
        const pb = document.createElement('div');
        pb.className = 'pin-badge';
        pb.textContent = 'üìå';
        cell.appendChild(pb);
      }

      // pin button
      const pinBtn = document.createElement('button');
      pinBtn.className = 'pin-btn' + (isPinned?' pinned':'');
      pinBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 2l2.5 6.5H21l-5.5 4 2 6.5L12 15l-5.5 4 2-6.5L3 8.5h6.5z"/></svg>`;
      pinBtn.onclick = e => {
        e.stopPropagation();
        if (!pinMode && !isPinned) return; // only toggle in pinMode or to unpin
        togglePin(p.id);
      };
      cell.appendChild(pinBtn);

      // hover overlay
      const ov = document.createElement('div');
      ov.className = 'overlay';
      ov.innerHTML = `<div class="overlay-date">${fmtShort(date)}${isScheduled?' üïê':''}</div>`;
      cell.appendChild(ov);

    } else {
      cell.classList.add('empty');
    }
    grid.appendChild(cell);
  }
}

// ‚îÄ‚îÄ APPLY PROFILE ‚îÄ‚îÄ
function applyProfile({handle,name,bio,website,avatar,followers,following,posts}) {
  document.getElementById('igHandle').textContent    = handle;
  document.getElementById('igName').textContent      = name;
  document.getElementById('igBio').innerHTML         = parseBio(bio);
  document.getElementById('igFollowers').textContent = followers;
  document.getElementById('igFollowing').textContent = following;
  document.getElementById('postCount').textContent   = posts;
  const wEl = document.getElementById('igWebsite');
  if (website) {
    wEl.textContent = website.replace(/^https?:\/\//,'');
    wEl.href = website.startsWith('http') ? website : 'https://'+website;
    wEl.style.display = 'block';
  } else { wEl.style.display='none'; }
  const inner = document.getElementById('avatarInner');
  inner.innerHTML = avatar
    ? `<img src="${avatar}" alt="">`
    : `<span class="avatar-letter">${(handle[0]||'?').toUpperCase()}</span>`;
}

function renderHighlights(items) {
  const wrap = document.getElementById('igHighlights');
  wrap.innerHTML = '';
  items.forEach(hl => {
    const el = document.createElement('div');
    el.className='hl-item';
    el.innerHTML=`<div class="hl-ring"><div class="hl-inner-ig"><span class="hl-emoji">${hl.emoji}</span></div></div><div class="hl-label-ig">${hl.label}</div>`;
    wrap.appendChild(el);
  });
}

// ‚îÄ‚îÄ PROFILE EDITOR ‚îÄ‚îÄ
function openProfileEditor() {
  document.getElementById('editHandle').value    = document.getElementById('igHandle').textContent;
  document.getElementById('editName').value      = document.getElementById('igName').textContent;
  document.getElementById('editBio').value       = document.getElementById('igBio').innerText;
  const wEl = document.getElementById('igWebsite');
  document.getElementById('editWebsite').value   = wEl.style.display==='none'?'':wEl.href;
  document.getElementById('editFollowers').value = document.getElementById('igFollowers').textContent;
  document.getElementById('editFollowing').value = document.getElementById('igFollowing').textContent;
  document.getElementById('editPublished').value = document.getElementById('postCount').textContent;
  const img = document.getElementById('avatarInner').querySelector('img');
  document.getElementById('editAvatar').value    = img?img.src:'';
  buildHlRows('editHlList', hlData);
  document.getElementById('editAddHlBtn').onclick = () => {
    hlData.push({emoji:'‚ú®',label:'Nuevo'}); buildHlRows('editHlList',hlData);
  };
  document.getElementById('profileOverlay').style.display='flex';
}

function saveProfileEditor() {
  applyProfile({
    handle:    document.getElementById('editHandle').value.trim()||'handle',
    name:      document.getElementById('editName').value.trim(),
    bio:       document.getElementById('editBio').value.trim(),
    website:   document.getElementById('editWebsite').value.trim(),
    avatar:    document.getElementById('editAvatar').value.trim(),
    followers: document.getElementById('editFollowers').value.trim()||'‚Äî',
    following: document.getElementById('editFollowing').value.trim()||'‚Äî',
    posts:     document.getElementById('editPublished').value.trim()||'‚Äî',
  });
  renderHighlights(hlData);
  closeProfileEditor();
}
function closeProfileEditor() { document.getElementById('profileOverlay').style.display='none'; }

function showStatus(loading, errMsg) {
  document.getElementById('config').style.display='none';
  const s = document.getElementById('status');
  s.style.display='block';
  s.innerHTML = loading
    ? `<div class="spinner"></div>`
    : `<p style="color:#c0392b;font-size:13px">‚ùå ${errMsg}</p>
       <button onclick="document.getElementById('status').style.display='none';document.getElementById('config').style.display='block';"
         style="margin-top:12px;padding:8px 16px;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-size:12px">‚Üê Reintentar</button>`;
}
</script>
</body>
</html>
